<!DOCTYPE html>
<html>
<head>
  <title>Employee Tracker</title>

  <style>
    body{font-family:Arial;text-align:center;margin-top:40px;}
    button{padding:10px 20px;margin:5px;cursor:pointer;}
    input{padding:8px;margin:5px;}
    img{max-width:150px;margin-bottom:20px;}
    #adminPanel{margin-top:20px;border-top:1px solid #ccc;padding-top:20px;}
  </style>
</head>

<body>

<img src="image.png">

<!-- LOGIN -->
<div id="loginBox">
  <h2>Login</h2>
  <input id="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <button onclick="login()">Login</button>
</div>

<!-- APP -->
<div id="app" style="display:none;">
  <h3 id="welcome"></h3>

  <button onclick="setStatus('Active')">Active</button>
  <button onclick="setStatus('Break')">Break</button>
  <button onclick="setStatus('WSW')">WSW</button>
  <button onclick="logout()">Logout</button>

  <br><br>
  <input type="date" id="reportDate">
  <button onclick="getMyReport()">View My Report</button>

  <h3 id="reportResult"></h3>

  <!-- ADMIN -->
  <div id="adminPanel" style="display:none;">
    <h3>Admin Report</h3>
    <input id="adminEmail" placeholder="Employee Email">
    <input type="date" id="adminDate">
    <button onclick="getAdminReport()">Get Report</button>

    <h3 id="adminResult"></h3>

    <br><br>
    <button onclick="getLive()">Live Status</button>
    <div id="liveBoard"></div>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycby-NSeS0Nmz8XOv9zwSDrx5If6R1-vYyiMvJgEF-wlu3pCRg1hpojS4HOcUtx42D2k/exec";
let user = {};

// LOGIN
function login() {
  fetch(API, {
    method: "POST",
    body: JSON.stringify({
      action: "login",
      email: email.value,
      password: password.value
    })
  })
  .then(r => r.json())
  .then(res => {
    if (res.success) {
      user = { email: email.value, name: res.name, role: res.role };
      loginBox.style.display = "none";
      app.style.display = "block";
      welcome.innerText = "Welcome " + res.name;

      setStatus("Active");

      if (res.role === "admin") {
        adminPanel.style.display = "block";
        getLive();
      }
    } else {
      alert("Invalid login");
    }
  });
}

// STATUS
function setStatus(status) {
  fetch(API, {
    method: "POST",
    body: JSON.stringify({
      action: "status",
      email: user.email,
      name: user.name,
      status: status
    })
  });
}

// LOGOUT
function logout() {
  setStatus("Logout");
  location.reload();
}

function secondsToHMS(s){
  const h = String(Math.floor(s/3600)).padStart(2,'0');
  const m = String(Math.floor((s%3600)/60)).padStart(2,'0');
  const sec = String(s%60).padStart(2,'0');
  return `${h}:${m}:${sec}`;
}

// EMPLOYEE REPORT
function getMyReport() {
  fetch(API, {
    method: "POST",
    body: JSON.stringify({
      action: "report",
      email: user.email,
      date: reportDate.value
    })
  })
  .then(r=>r.json())
  .then(res=>{
    reportResult.innerHTML = `
      Active: ${secondsToHMS(res.active)} <br>
      Break: ${secondsToHMS(res.break)} <br>
      WSW: ${secondsToHMS(res.wsw)} <br>
      Total System: ${secondsToHMS(res.total)} <br>
      Total Work: ${secondsToHMS(res.active + res.wsw)}
    `;
  });
}

// ADMIN REPORT
function getAdminReport() {
  fetch(API, {
    method: "POST",
    body: JSON.stringify({
      action: "report",
      email: adminEmail.value,
      date: adminDate.value
    })
  })
  .then(r=>r.json())
  .then(res=>{
    adminResult.innerHTML = `
      Active: ${secondsToHMS(res.active)} <br>
      Break: ${secondsToHMS(res.break)} <br>
      WSW: ${secondsToHMS(res.wsw)} <br>
      Total System: ${secondsToHMS(res.total)} <br>
      Total Work: ${secondsToHMS(res.active + res.wsw)}
    `;
  });
}

// LIVE BOARD
function getLive() {
  fetch(API, {
    method: "POST",
    body: JSON.stringify({ action: "live" })
  })
  .then(r=>r.json())
  .then(res=>{
    let html = "<h3>Today's Live Status</h3>";
    for (let email in res.data) {
      const u = res.data[email];
      html += `${u.name} (${email}) - ${u.status} at ${u.time}<br>`;
    }
    liveBoard.innerHTML = html;
  });
}

// AUTO REFRESH FOR ADMIN
setInterval(()=>{
  if(user.role === "admin") getLive();
}, 10000);

</script>

</body>
</html>
